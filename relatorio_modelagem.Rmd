---
title: "Modelagem final"
output: html_document
date: "2025-11-15"
---

# Modelagem inicial: seleção de variáveis preditoras via regressão simples

## Modelos univariados para OR e AUC:
```{r}
# Etapa 1: regressões logísticas simples por variável
# Este script supõe que funcoes_modelagem.R foi carregado

library(tidyverse)

source("funcoes_modelagem.R")

#----------------------------------------------------------
# 0. Reprodutibilidade (renv + seed)

# renv::init()

set.seed(1234)

#----------------------------------------------------------
# 1. Leitura da base analítica

dados_analitico_FINAL <- ler_dados_analiticos("dados_analitico_FINAL.xlsx")

# Nome do desfecho
desfecho <- "desfecho_exacerbacao_1ano"

#----------------------------------------------------------
# 2. Definição dos blocos de variáveis e exclusões

# Bloco: variáveis demográficas categóricas
vars_cat_demog_univ <- list(
  list(
    var = "sexo",
    label = "Sexo",
    excluir_niveis = character(),
    ref = "F"
  ),
  list(
    var = "rbl_fumo",
    label = "Tabagismo",
    excluir_niveis = c("Não descrito"),
    ref = "Tabagista"
  ),
  list(
    var = "rbl_exposicoes",
    label = "Exposições ambientais",
    excluir_niveis = c("Não descrito"),
    ref = "Ambiental"
  ),
  list(
    var = "rbl_fogao_a_lenha",
    label = "Fogão a lenha",
    excluir_niveis = c("Não descrito"),
    ref = "Sim"
  ),
  list(
    var = "cbl_comorbidades_obesidade",
    label = "Obesidade",
    excluir_niveis = character(),
    ref = "1"
  ),
  list(
    var = "cbl_comorbidades_ansiedade_depressao",
    label = "Ansiedade/Depressão",
    excluir_niveis = character(),
    ref = "1"
  ),
  list(
    var = "cbl_comorbidades_drge",
    label = "DRGE",
    excluir_niveis = character(),
    ref = "1"
  ),
  list(
    var = "cbl_comorbidades_rinite_alergica",
    label = "Rinite alérgica",
    excluir_niveis = character(),
    ref = "1"
  ),
  list(
    var = "cbl_comorbidades_saos",
    label = "SAOS",
    excluir_niveis = character(),
    ref = "1"
  ),
  list(
    var = "cbl_comorbidades_outros_diagnosticos",
    label = "Outras comorbidades",
    excluir_niveis = character(),
    ref = "1"
  )
)

# Bloco: variáveis demográficas contínuas
vars_demog_cont_univ <- list(
  list(
    var = "idade_td",
    label = "Idade"
  ),
  list(
    var = "imc_td",
    label = "IMC"
  )
)

# Bloco: variáveis clínicas 
vars_cat_clinicas_univ <- list(
  list(
    var = "rbl_adesao_e_tecnica_de_inalacao",
    label = "Adesão e técnica inalatória",
    excluir_niveis = c("Não avaliada"),
    ref = "Insatisfatória"
  ),
  list(
    var = "rbl_ausculta",
    label = "Ausculta",
    excluir_niveis = c("Não avaliada"),
    ref = "Alterada"
  ),
  list(
    var = "rbl_evolucao_no_ultimo_ano",
    label = "Evolução no último ano",
    excluir_niveis = ("Não descrito"),
    ref = "Aumento da dose"
  ),
  list(
    var = "rbl_exame_fisico",
    label = "Exame físico",
    excluir_niveis = ("Não avaliada"),
    ref = "Eupneico"
  ),
  list(
    var = "rbl_internacao_previa",
    label = "Internação para verificar adesão",
    ref = "Sim"
  ),
  list(
    var = "cbl_comorbidades_rbl_drge_controlada",
    label = "DRGE controlada",
    excluir_niveis = c("Não avaliado", "Sem a comorbidade"),
    ref = "Não"
  ),
  list(
    var = "cbl_comorbidades_rbl_rinite_alergica_controlada",
    label = "Rinite alérgica controlada",
    excluir_niveis = c("Não avaliado", "Sem a comorbidade"),
    ref = "Não"
  ),
  list(
    var = "cbl_comorbidades_rbl_saos_em_tratamento",
    label = "SAOS em tratamento",
    excluir_niveis = c("Não avaliado", "Sem a comorbidade"),
    ref = "Não"
  ),
  list(
    var = "rbl_risco_de_morte",
    label = "Risco de morte",
    excluir_niveis = ("Não descrito"),
    ref = "Sim"
  ),
  list(
    var = "cbl_sintomas_atuais_dispneia",
    label = "Dispneia"
  ),
  list(
    var = "cbl_sintomas_atuais_outros_sintomas",
    label = "Outros sintomas"
  ),
    list(
    var = "cbl_sintomas_atuais_sibilos",
    label = "Sibilos"
  ),
    list(
    var = "cbl_sintomas_atuais_tosse",
    label = "Tosse"
  ),
    list(
    var = "cbl_sintomas_atuais_uso_de_bd_de_alivio",
    label = "Uso de BD de alívio"
  )
)

# Bloco: variáveis de biomarcadores (contínuas)
vars_biomarcadores_univ <- list(
  list(var = "eosinofilos_media", label = "Eosinófilos (média)"),
  list(var = "ig_e", label = "IgE Total sérica")
)

# Bloco: variáveis espirométricas (contínuas)
vars_espiro_cont_univ <- list(
  list(var = "vef1_l_recente", label = "VEF1 (L) recente"),
  list(var = "vef1_pct_recente", label = "VEF1 (% predito) recente"),
  list(var = "cvf_l_recente", label = "CVF (L) recente"),
  list(var = "cvf_pct_recente", label = "CVF (% predito) recente"),
  list(var = "vef1_cvf_recente", label = "VEF1/CVF recente"),
  list(var = "vef1_l_cv", label = "VEF1 CV"),
  list(var = "vef1_pct_cv", label = "VEF1 (%) CV"),
  list(var = "cvf_l_cv", label = "CVF CV"),
  list(var = "cvf_pct_cv", label = "CVF (%) CV"),
  list(var = "vef1_cvf_cv", label = "VEF1/CVF CV")
)

# Bloco: variáveis de resposta ao BD, restrita à subamostra
dados_mult_espiro <- dados_analitico_FINAL |>
  dplyr::filter(dplyr::if_any(
    dplyr::all_of(c("vef1_l_cv", "vef1_pct_cv",
                    "cvf_l_cv", "cvf_pct_cv",
                    "vef1_cvf_cv")),
    ~ !is.na(.x)
  ))

vars_espiro_cat_univ <- list(
  list(
    var = "vef1_resposta_bd_variavel",
    label = "Resposta BD variável (restrita a múltiplas espirometrias)",
    excluir_niveis = character(),
    ref = "Sim"
  ),
list(
    var = "vef1_resposta_bd_ultima",
    label = "Resposta BD na última espirometria",
    excluir_niveis = character(),
    ref = "Sim"
  )
)

# Bloco: regime terapêutico (todas 0/1, exceto regime_budesonida_duplo)
vars_cat_terapeutico_univ <- list(
  list(
    var = "cbl_budesonida_com_formoterol_dosagem_alternativa",
    label = "Budesonida/Formoterol dosagem alternativa",
    ref = "Sim"
  ),
  list(
    var = "cbl_medicacoes_em_uso_beclometasona_spray_250_mcg_2x_dia",
    label = "Beclometasona spray 250 mcg 2x/dia"
  ),
  list(
    var = "cbl_medicacoes_em_uso_budesonida_400_mcg_1x_dia_cedo",
    label = "Budesonida 400 mcg 1x/dia cedo"
  ),
  list(
    var = "cbl_medicacoes_em_uso_budesonida_400_mcg_2x_dia",
    label = "Budesonida 400 mcg 2x/dia"
  ),
  list(
    var = "cbl_medicacoes_em_uso_budesonida_400_mcg_formoterol_12_mcg_alenia_2x_dia",
    label = "Budesonida/Formoterol (Alenia) 2x/dia"
  ),
  list(
    var = "cbl_medicacoes_em_uso_budesonida_nasal_ou_outro_corticosteroide_nasal_dose",
    label = "Corticoide nasal"
  ),
  list(
    var = "cbl_medicacoes_em_uso_formoterol_12_mcg_2x_dia",
    label = "Formoterol 12 mcg 2x/dia"
  ),
  list(
    var = "cbl_medicacoes_em_uso_mepolizumabe",
    label = "Mepolizumabe"
  ),
  list(
    var = "cbl_medicacoes_em_uso_montelucaste",
    label = "Montelucaste"
  ),
  list(
    var = "cbl_medicacoes_em_uso_omeprazol_ou_outro_ibp",
    label = "Omeprazol ou IBP"
  ),
  list(
    var = "cbl_medicacoes_em_uso_outras_medicacoes",
    label = "Outras medicações"
  ),
  list(
    var = "cbl_medicacoes_em_uso_prednisona_dose_e_duracao",
    label = "Prednisona"
  ),
  list(
    var = "cbl_medicacoes_em_uso_salbutamol_100_mcg_se_necessario",
    label = "Sabutamol 100mcg"
  ),
  list(
    var = "cbl_medicacoes_em_uso_tiotropio_ou_outro_lama",
    label = "Tiotrópio ou outro LAMA"
  ),
  list(
    var = "regime_budesonida_duplo",
    label = "CEi 1600mcg",
    ref = "Sim"
  )
)

#----------------------------------------------------------
# 3. Ajuste dos modelos por bloco


# Demográficas categóricas
res_demog_cat <- ajustar_bloco_categoricas(
  data = dados_analitico_FINAL,
  outcome = desfecho,
  vars_list = vars_cat_demog_univ
)

# Demográficas contínuas (idade, IMC)
res_demog_cont <- ajustar_bloco_numericas(
  data = dados_analitico_FINAL,
  outcome = desfecho,
  vars_num = vars_demog_cont_univ
)

# Clínicas categóricas (base completa)
res_clinicas_cat <- ajustar_bloco_categoricas(
  data = dados_analitico_FINAL,
  outcome = desfecho,
  vars_list = vars_cat_clinicas_univ
)

# Biomarcadores contínuos
res_biomarcadores <- ajustar_bloco_numericas(
  data = dados_analitico_FINAL,
  outcome = desfecho,
  vars_num = vars_biomarcadores_univ
)

# Espirometria (contínuas) na base completa
res_espiro_cont <- ajustar_bloco_numericas(
  data = dados_analitico_FINAL,
  outcome = desfecho,
  vars_num = vars_espiro_cont_univ
)

# Resposta BD variável na subamostra de múltiplas espirometrias
res_espiro_bd <- ajustar_bloco_categoricas(
  data = dados_mult_espiro,
  outcome = desfecho,
  vars_list = vars_espiro_cat_univ
)

# Regime terapêutico (categóricas binárias 0/1)
res_terapeutico_cat <- ajustar_bloco_categoricas(
  data = dados_analitico_FINAL,
  outcome = desfecho,
  vars_list = vars_cat_terapeutico_univ
)

#----------------------------------------------------------
# 4. Exportar/organizar resultados para o Rmd

# Exemplo: salvar em objetos que serão usados no .Rmd
save(
  res_demog_cat,
  res_demog_cont,
  res_clinicas_cat,
  res_biomarcadores,
  res_espiro_cont,
  res_espiro_bd,
  res_terapeutico_cat,
  file = "resultados_univariada.RData"
)

# Caso queira visualizar alguma classe de ref em específico, use: 
# levels(dados_analitico_FINAL$###) ou levels(dados_mult_espiro$###)
```

